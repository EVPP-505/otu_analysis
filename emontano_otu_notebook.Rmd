---
title: "OTU Analysis"
date: "25-April-2018"
output: html_notebook
---

## Statement of Problem

This is a notebook for analyzing the OTU (operational taxonomic unit) tables generated by the EVPP-490/643 class.  The initial OTU table for this analysis is based on soil samples.  Half the soil samples (#1-6) were collected upstream of a wastewater treatment plant and half (#7-12) were collected downstream. We are interested in comparing both alpha and beta diversity statistics. 

This table goes out to the highest level taxa identification, and generates 1,475 OTUs for each of 12 soil samples.

We will use the following libraries for the analysis:

```{r libraries}
library(tidyverse) # general data wrangling
library(readxl) # read the provided excel files

# we might need libraries for analysis that are not be installed.
# the following code will test for the presence of the library and install if necessary
# create a list of packages to be tested
list_of_packages <- c("vegan")
# compare the list to the installed packages
new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
# install packages if not found
if(length(new_packages)>0){install.packages(new_packages)}

# load the new library
library(vegan) # ecological analysis package
```


The first task is to load the data we need.  We are maintaining a good project structure by keeping all original (source) data in a separate directory.  We can see there are two files in the `data` directory, a .csv file and a .xlsx file.  The OTU data are in the csv file.

```{r load-data}
# load the otu data
otu_data <- read_csv("data/RDP_Genus_Pohick.csv")

# look at the structure of the data
otu_data
```

We might start with describing different aspects of the data. How many kingdoms are represented?

```{r kingdoms}
otu_data %>% 
  distinct(Kingdom)
```

How many phyla?

```{r phylum}
otu_data %>% 
  distinct(Phylum)
```

There are 75 distinct phyla in the data, which can be a little cumbersome to visualize.  Each sample cell is a percent contribution of the total DNA to the sample.  So, we can look at the relative contribution to decide how or whether to limit what phyla to look at.

```{r}
otu_data %>% 
  group_by(Phylum) %>% # group the data by distinct Phylum
  summarise(cnt = n()) %>% # calculate the count of each group
  mutate(abund = cnt/sum(cnt)) %>% # calculate the relative abundance
  arrange(desc(abund)) # arrange in descending order (largest to smallest)

```

The relative abundance drops off quickly, and it looks like the majority of the top 10 are bacteria.  I'm not familiar with these data, so I will choose to limit these data to a particular group of phyla for the sake of example.  We will filter the data to just bacteria.  

It also looks like bacteria has two different spellings.  We can accomodate both.

```{r filter-kingdom}
# filter the data and confirm we are only looking at bacteria
otu_data %>% 
  # use regex to find phyla ending with bacteria or (|) bacteriia
  filter(str_detect(Phylum, "bacteria$|bacteriia$")) %>% 
  distinct(Phylum) # find the distinct entries
# this finds 20 distinct phyla, which is more workable than 75

# now create a subset of the data
bacteria <- otu_data %>% 
  filter(str_detect(Phylum, "bacteria$|bacteriia$"))
# take a look at the new data
bacteria
```

There are now 1065 (`nrow(bacteria)`) rows from the original 1475 (`nrow(otu_data)`).  That's not a huge reduction, but we have been able to reduce the volume of data to analyze, focusing on what seems the dominant phyla.  Let's take a look at the sum for each sample.

```{r sum-samples}
bacteria %>%
  # only run the summaries for the columns with the name Sample
  summarise_at(vars(matches("Sample")), sum)
  
```

Let's look at the relative abundance of the phyla present.  There are 20, so we might need to weed out those that are not necessarily representative, say < 2%.

```{r phy-abund}
bacteria %>% # use the bacteria subset
  group_by(Phylum) %>% # group on Phylum
  summarise(cnt = n()) %>% # calculate the counts
  mutate(abund = cnt/sum(cnt)) %>% # calculate the relative abundance
  arrange(desc(abund)) # arrange in descending order
```

There are several Phylum that are below the 2% threshold, so filter on those.

```{r filter-abund}
# we can reuse the code above an add a filter at the end
phylum_subset <- bacteria %>% 
  group_by(Phylum) %>% # group on Phylum
  summarise(cnt = n()) %>% # calculate the counts
  mutate(abund = cnt/sum(cnt)) %>% # calculate the relative abundance
  filter(abund > 0.02) %>% 
  arrange(desc(abund))
phylum_subset
```

We are left with 8 (`nrow(phylum_subset`)) phyla, so we can extract just those from the OTU table.

```{r extract-phy}
# Use the results of the relative abundance to filter the main
# bacteria data set
two_pct_abund <- bacteria %>% # use the main bacteria data
  semi_join(., phylum_subset, by = "Phylum") # use a filtering join to remove unwanted rows

two_pct_abund # print the result

```

We now have a set of 1006 (`nrow(two_pct_abund`)) entries.  Let's take a look at means for upstream versus downstream.  Per the information provided with the data, the samples 1-6 are upstream and 7-12 are downstream.

```{r upstream-bacteria}
# look at the column names
# colnames(two_pct_abund)

# create the upstream data
# I'm including some extra variations on selecting a subset of columns for reference.
# You can uncomment/comment to see what different lines of code accomplish.
# The choice is yours in terms of what you might like to keep and use later, I'm choosing to 
# select a smaller group of columns for convenience
upstream_bacteria <- two_pct_abund %>%
  # select the first 6 samples with phylum
  select(4, 11:16) #using numeric ranges
  # select(Phylum, num_range("Sample", 1:6)) # using names
  # select(one_of("Phylum", "Sample1", "Sample2", "Sample3", "Sample4", "Sample5", "Sample6")) #longhand
  # keep all columns except the downstream
  # select(-num_range("Sample", 7:12)) 
upstream_bacteria
```

```{r downstream-bacteria}
# create the upstream data
downstream_bacteria <- two_pct_abund %>% 
  # select the last 6 samples with phylum
  # select(one_of("Phylum", "Sample7", "Sample8", "Sample9", "Sample10", "Sample11", "Sample12"))
  select(Phylum, num_range("Sample", 7:12)) # using names
downstream_bacteria
```

We want to look at the sum of all the samples for upstream by phylum.  We do this by summing across all the rows of each sample into a new column.  Then we sum the new column by distinct phylum.

```{r upstream-sums}
upstream_sums <- upstream_bacteria %>% # use the upstream data
  mutate(samplesums = rowSums(select_(., "-Phylum"))) %>% # calculate the sum across all the samples
  group_by(Phylum) %>% # regroup by distinct Phylum
  summarise(allsum = sum(samplesums)) # calculate the sum for each phylum

upstream_sums
```

Now do the same for the downstream samples.

```{r downstream-sums}
downstream_sums <- downstream_bacteria %>% # use the upstream data
  mutate(samplesums = rowSums(select_(., "-Phylum"))) %>% # calculate the sum across all the samples
  group_by(Phylum) %>% # regroup by distinct Phylum
  summarise(allsum = sum(samplesums)) # calculate the sum for each phylum

downstream_sums
```

